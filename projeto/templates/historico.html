{% extends "base.html" %}

{% block title %}GDCB - Histórico de Doações{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', path='doacao.css') }}">
{% endblock %}

{% block content %}
    <form method="get" class="filtros-container">
        <div class="filtros-card">

            <div class="filtro-item">
                <label for="campanha">Campanha</label>
                <select name="campanha_id" id="campanha">
                    <option value="">Todas</option>
                    {% for c in campanhas %}
                    <option value="{{ c.id }}"
                        {% if request.query_params.get('campanha_id', '') == (c.id|string) %}selected{% endif %}>
                        {{ c.titulo }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filtro-item">
                <label for="doador">Doador</label>
                <select name="doador_id" id="doador">
                    <option value="">Todos</option>
                    {% for d in doadores %}
                    <option value="{{ d.id }}"
                        {% if request.query_params.get('doador_id', '') == (d.id|string) %}selected{% endif %}>
                        {{ d.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filtro-item">
                <label for="tipo">Tipo de doação</label>
                <select name="tipo" id="tipo">
                    <option value="">Todos</option>
                    <option value="dinheiro" {% if request.query_params.get('tipo','') == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                    <option value="itens" {% if request.query_params.get('tipo','') == 'itens' %}selected{% endif %}>Itens</option>
                </select>
            </div>

            <div class="filtro-item">
                <label for="data">Data</label>
                <input type="date" name="data" id="data"
                    value="{{ request.query_params.get('data','') }}">
            </div>

            <button type="submit" class="btn-filtrar">Filtrar</button>
        </div>
    </form>


    <div class="historico-wrapper">
        <section class="historico-section">
            <h2>Histórico</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome Doador</th>
                            <th>Campanha</th>
                            <th>Data doação</th>
                            <th>Tipo doação</th>
                            <th>Valor</th>
                            <th>Quantidade de itens</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for doacao in doacoes %}
                        <tr>
                            <td>{{ doacao.nome_doador }}</td>
                            <td>{{ doacao.campanha }}</td>
                            <td>{{ doacao.data }}</td>
                            <td>{{ doacao.tipo }}</td>
                            <td>{{ doacao.valor if doacao.valor else "-" }}</td>
                            <td>{{ doacao.quantidade if doacao.quantidade else "-" }}</td>
                            <td>{{ doacao.descricao if doacao.descricao else "-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </section>
    </div>

    <div class="graficos-duplos">

    <!-- Gráfico 1 - Tipo de Doação -->
    <div class="grafico-wrapper">
        <h3>Distribuição por Tipo de Doação</h3>
        <div class="grafico-container">
            <canvas id="graficoTipo"></canvas>
        </div>
    </div>

    <!-- Gráfico 2 - Campanhas com Mais Doações -->
    <div class="grafico-wrapper">
        <h3>Campanhas com Mais Doações</h3>
        <div class="grafico-container">
            <canvas id="graficoCampanhas"></canvas>
        </div>
    </div>

</div>

    

    <!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const doacoes = {{ doacoes | tojson }};

    // ---------- GRÁFICO DE TIPOS ----------
    let qtdItens = 0;
    let qtdDinheiro = 0;

    doacoes.forEach(d => {
        if (d.tipo === "itens") qtdItens++;
        if (d.tipo === "dinheiro") qtdDinheiro++;
    });

    new Chart(document.getElementById("graficoTipo"), {
        type: "pie",
        data: {
            labels: ["Itens", "Dinheiro"],
            datasets: [{
                data: [qtdItens, qtdDinheiro],
                backgroundColor: ["#4a7df2", "#2ecc71"]
            }]
        },
        options: { responsive: true }
    });


    // ---------- GRÁFICO DE CAMPANHAS ----------

    // Agrupa doações por campanha
    const contagemCampanhas = {};
    doacoes.forEach(d => {
        if (!contagemCampanhas[d.campanha]) contagemCampanhas[d.campanha] = 0;
        contagemCampanhas[d.campanha]++;
    });

    const labelsCampanhas = Object.keys(contagemCampanhas);
    const valoresCampanhas = Object.values(contagemCampanhas);

    new Chart(document.getElementById("graficoCampanhas"), {
        type: "bar",
        data: {
            labels: labelsCampanhas,
            datasets: [{
                label: "Número de Doações",
                data: valoresCampanhas,
                backgroundColor: "#1c52a8"
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

</script>


{% endblock %}
